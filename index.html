<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="public/icon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <title>GOG 角色车卡系统</title>
    <style>
        @import url(style.css);
    </style>
    <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>

<body>
    <div id="toast" class="toast-hidden">角色已保存！</div>

    <div class="container" id="main-container">
        <div
            style="color:#eeeeee;font-size:30px;font-weight:bolder;position:fixed;top:10px;left:0;right:0;z-index:1;text-align: center;margin: 0 auto;">
            GOG TRPG</div>
        <div class="character-sheet">
            <div class="basic-attribution-container">
                <div class="section">
                    <div class="character-info-grid">
                        <div class="character-portrait-container">
                            <!-- 肖像显示区域 -->
                            <div class="portrait-preview" id="portrait-preview">
                                <img id="character-portrait" src="" alt="角色肖像"
                                    style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                <div id="portrait-placeholder">暂无肖像<br />(w:h=4:5)</div>
                            </div>
                        </div>

                        <div class="character-form-fields">
                            <div class="form-group" style="grid-column: span 2;">
                                <label for="character-name">姓名</label>
                                <div class="auto-height-content" contenteditable="true" id="character-name"
                                    style="font-size: 14px; width: 100%;"></div>
                            </div>

                            <div class="form-group" style="grid-column: span 2;">
                                <label for="player-name">玩家</label>
                                <div class="auto-height-content" contenteditable="true" id="player-name"
                                    style="font-size: 14px; width: 100%;"></div>
                            </div>
                            <div class="form-group">
                                <label for="character-gender">性别</label>
                                <div class="select-container">
                                    <div class="custom-select" tabindex="0">
                                        <select id="character-gender">
                                            <option value="男">男</option>
                                            <option value="女">女</option>
                                            <option value="其他">其他</option>
                                            <option value="未知">未知</option>
                                        </select>
                                        <div class="select-selected">男</div>
                                        <div class="select-items">
                                            <div class="select-item" data-value="男">男</div>
                                            <div class="select-item" data-value="女">女</div>
                                            <div class="select-item" data-value="其他">其他</div>
                                            <div class="select-item" data-value="未知">未知</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="character-age">年龄</label>
                                <input type="number" id="character-age" min="0">
                            </div>

                            <div class="form-group">
                                <label for="character-alignment">阵营</label>
                                <div class="select-container">
                                    <div class="custom-select" tabindex="0">
                                        <select id="character-alignment">
                                            <option value="守序善良">守序善良</option>
                                            <option value="中立善良">中立善良</option>
                                            <option value="混乱善良">混乱善良</option>
                                            <option value="守序中立">守序中立</option>
                                            <option value="绝对中立">绝对中立</option>
                                            <option value="混乱中立">混乱中立</option>
                                            <option value="守序邪恶">守序邪恶</option>
                                            <option value="中立邪恶">中立邪恶</option>
                                            <option value="混乱邪恶">混乱邪恶</option>
                                        </select>
                                        <div class="select-selected">守序善良</div>
                                        <div class="select-items">
                                            <div class="select-item" data-value="守序善良">守序善良</div>
                                            <div class="select-item" data-value="中立善良">中立善良</div>
                                            <div class="select-item" data-value="混乱善良">混乱善良</div>
                                            <div class="select-item" data-value="守序中立">守序中立</div>
                                            <div class="select-item" data-value="绝对中立">绝对中立</div>
                                            <div class="select-item" data-value="混乱中立">混乱中立</div>
                                            <div class="select-item" data-value="守序邪恶">守序邪恶</div>
                                            <div class="select-item" data-value="中立邪恶">中立邪恶</div>
                                            <div class="select-item" data-value="混乱邪恶">混乱邪恶</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="character-nationality">国籍</label>
                                <input type="text" id="character-nationality">
                            </div>

                            <div class="form-group">
                                <label for="character-class">职业</label>
                                <input type="text" id="character-class">
                            </div>

                            <div class="form-group">
                                <label for="character-blessing">赐福</label>
                                <input type="text" id="character-blessing">
                            </div>
                        </div>
                    </div>

                    <div class="form-group full-width" style="display: block;">
                        <label for="character-description">描述：</label>
                        <div class="auto-height-content" contenteditable="true" id="character-description"
                            style="font-size: 14px;"></div>
                    </div>
                </div>

                <div class="section">
                    <div class="attributes-grid">
                        <div class="attribute-item">
                            <label for="attr-STR">力量</label>
                            <input type="number" min="0" step="1" value="3" class="current-value" id="attr-STR">
                        </div>

                        <div class="attribute-item">
                            <label for="attr-DEX">敏捷</label>
                            <input type="number" min="0" step="1" value="3" class="current-value" id="attr-DEX">
                        </div>

                        <div class="attribute-item">
                            <label for="attr-INT">智慧</label>
                            <input type="number" min="0" step="1" value="3" class="current-value" id="attr-INT">
                        </div>

                        <div class="attribute-item">
                            <label for="attr-CHA">魅力</label>
                            <input type="number" min="0" step="1" value="3" class="current-value" id="attr-CHA">
                        </div>

                        <div class="attribute-item">
                            <label for="attr-WIS">感知</label>
                            <input type="number" min="0" step="1" value="3" class="current-value" id="attr-WIS">
                        </div>

                        <div class="attribute-item">
                            <label for="attr-MAG">法力</label>
                            <input type="number" min="0" step="1" value="3" class="current-value" id="attr-MAG">
                        </div>

                        <div class="attribute-item">
                            <label for="attr-HP-current">健康</label>
                            <div class="attribute-controls" style="gap: 0px;">
                                <input type="number" id="attr-HP-base" min="0" value="25" title="基础值"
                                    class="base-value">
                                <input type="number" id="attr-HP-current" value="5" title="当前值" class="current-value">
                                <div class="health-bar-container">
                                    <div class="health-bar" id="hp-bar"></div>
                                    <div class="health-base-bar" id="hpb-bar"></div>
                                </div>
                                <span class="max-value" id="attr-HP-max" title="上限=种族基础值+力量×2">15</span>
                            </div>
                        </div>

                        <div class="attribute-item">
                            <label for="attr-MP-current">精力</label>
                            <div class="attribute-controls" style="gap: 0px;">
                                <input type="number" id="attr-MP-base" min="0" value="5" title="基础值" class="base-value">
                                <input type="number" id="attr-MP-current" value="5" title="当前值" class="current-value">
                                <div class="mana-bar-container">
                                    <div class="mana-bar" id="mp-bar"></div>
                                    <div class="mana-base-bar" id="mpb-bar"></div>
                                </div>
                                <span class="max-value" id="attr-MP-max" title="上限=种族基础值+法力">10</span>
                            </div>
                        </div>
                    </div>

                    <h2>状态</h2>
                    <div id="status-tags" style="margin-top: 5px;">
                        <!-- 标签将通过JavaScript动态生成 -->
                    </div>
                    <div class="tag-input">
                        <input type="text" id="new-tag" placeholder="示例：疯狂(1)：魅力-1，法力-1"
                            style="padding: 7px 15px; border-radius: 0; border: none; border-right: 1px solid #eeeeee;">
                        <button id="add-tag" class="btn"
                            style="border-radius: 0px 7px 7px 0px;border: none; height: 100%;">添加</button>
                    </div>
                </div>
            </div>

            <div class="section" style="grid-column: span 2;">
                <div class="blessing-grid">
                    <input class="blessingFullName" type="text" id="blessingFullName" placeholder="权柄编号-神明职能-神明称号-神明真名">

                    <div class="form-group" style="display:flex;">
                        <label for="blessing-level" style="min-width: max-content; margin:6px 0;">赐福等级</label>
                        <div class="select-container">
                            <div class="custom-select" tabindex="0">
                                <select id="blessing-level">
                                    <option value="0">0级</option>
                                    <option value="1">1级</option>
                                    <option value="2">2级</option>
                                    <option value="3">3级</option>
                                    <option value="4">4级</option>
                                    <option value="5">5级</option>
                                    <option value="6">6级</option>
                                    <option value="7">7级</option>
                                    <option value="8">8级</option>
                                    <option value="9">9级</option>
                                    <option value="10">10级</option>
                                </select>
                                <div class="select-selected">0级</div>
                                <div class="select-items">
                                    <div class="select-item" data-value="0">0级</div>
                                    <div class="select-item" data-value="1">1级</div>
                                    <div class="select-item" data-value="2">2级</div>
                                    <div class="select-item" data-value="3">3级</div>
                                    <div class="select-item" data-value="4">4级</div>
                                    <div class="select-item" data-value="5">5级</div>
                                    <div class="select-item" data-value="6">6级</div>
                                    <div class="select-item" data-value="7">7级</div>
                                    <div class="select-item" data-value="8">8级</div>
                                    <div class="select-item" data-value="9">9级</div>
                                    <div class="select-item" data-value="10">10级</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-auto">
                    <table class="blessing-table">
                        <thead>
                            <tr>
                                <th style="width: 10%;">赐福等级</th>
                                <th style="width: 20%;">关联属性</th>
                                <th style="width: 30%;">赐福特技</th>
                                <th style="width: 30%;">异化程度</th>
                                <th style="width: 10%;">操作</th>
                            </tr>
                        </thead>
                        <tbody id="blessing-container">
                            <!-- 动态生成数据 -->
                        </tbody>
                    </table>
                </div>
                <div class="form-group" style="margin-top: 0px; padding: 0px;">
                    <button id="add-blessingSystem" class="btn blessing-list-btn">+</button>
                </div>

                <div class="table-auto">
                    <table class="blessing-skills-table">
                        <thead>
                            <tr>
                                <th style="width: 15%;">特技名</th>
                                <th style="width: 75%;">描述</th>
                                <th style="width: 10%;">操作</th>
                            </tr>
                        </thead>
                        <tbody id="blessing-skills-container">
                            <!-- 动态生成数据 -->
                        </tbody>
                    </table>
                </div>
                <div class="form-group" style="margin-top: 0px; padding: 0px;">
                    <button id="add-blessingSkills" class="btn blessing-list-btn">+</button>
                </div>
            </div>

            <div class="section" style="grid-column: span 2;">
                <h2>特技</h2>
                <label>技能熟练度总点数: <span id="skill-prof-left" style="color: #28a745;">0</span></label>
                <div class="table-auto">
                    <table class="skills-list">
                        <thead>
                            <tr>
                                <th style="width: 15%;">特技名</th>
                                <th style="width: 10%;" title="技能熟练度在1~5之间；1：略懂；2：学徒；3：专家；4：精通；5：大师。">熟练度</th>
                                <th style="width: 10%;">经验</th>
                                <th style="width: 55%;">描述</th>
                                <th style="width: 10%;">操作</th>
                            </tr>
                        </thead>
                        <tbody id="skills-container">
                            <!-- 技能列表将通过JavaScript动态生成 -->
                        </tbody>
                    </table>
                </div>

                <div class="form-group"
                    style="margin-top: 15px;max-width: 250px;display: grid;grid-template-columns: 2fr 1fr;">
                    <div class="select-container">
                        <div class="custom-select" tabindex="0">
                            <select id="skill-category-select"
                                style="color: #666666;border-left: 1px solid #eeeeee;border-top: 1px solid #eeeeee;border-bottom: 1px solid #eeeeee;border-radius: 8px 0px 0px 8px;">
                                <option value="STR">力量类技能</option>
                                <option value="DEX">敏捷类技能</option>
                                <option value="INT">智慧类技能</option>
                                <option value="CHA">魅力类技能</option>
                                <option value="WIS">感知类技能</option>
                                <option value="MAG">法力类技能</option>
                                <option value="PRF">职业类技能</option>
                            </select>
                            <div class="select-selected style1"
                                style="color: #666666;border: 1px solid #eeeeee; border-right: none; border-radius: 8px 0px 0px 8px;padding-left: 12px;">
                                力量类技能</div>
                            <div class="select-items">
                                <div class="select-item" data-value="STR">力量类技能</div>
                                <div class="select-item" data-value="DEX">敏捷类技能</div>
                                <div class="select-item" data-value="INT">智慧类技能</div>
                                <div class="select-item" data-value="CHA">魅力类技能</div>
                                <div class="select-item" data-value="WIS">感知类技能</div>
                                <div class="select-item" data-value="MAG">法力类技能</div>
                                <div class="select-item" data-value="PRF">职业类技能</div>
                            </div>
                        </div>
                    </div>
                    <button id="add-skill" class="btn" style="border-radius: 0px 8px 8px 0px;"
                        title="支持自创技能喵~">添加技能</button>
                </div>
            </div>

            <div class="section" style="grid-column: span 2;">
                <h2>装备</h2>
                <div class="table-auto">
                    <table class="items-list">
                        <thead>
                            <tr>
                                <th style="width: 15%;">名称</th>
                                <th style="width: 75%;">描述</th>
                                <th style="width: 10%;">操作</th>
                            </tr>
                        </thead>
                        <tbody id="equipment-container">
                            <!-- 装备列表将通过JavaScript动态生成 -->
                        </tbody>
                    </table>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <button id="add-equipment" class="btn" title="支持自创装备喵~">添加装备</button>
                </div>
            </div>

            <div class="section" style="grid-column: span 2;">
                <h2>背包</h2>
                <div class="auto-height-content" contenteditable="true" id="inventory" style="font-size: 14px;"></div>
            </div>
            <div class="section" style="grid-column: span 2;">
                <h2>日志</h2>
                <p style="font-size: 14px; color: #dddddd">（你的形象描述、思想与信念、重要之人、珍视之物、意义非凡之地、特质、伤口与疤痕……）</p>
                <div id="log-sections">
                    <!-- 标签将通过JavaScript动态生成 -->
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <button id="add-log" class="btn">添加日志</button>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-container">
            <!-- 新建按钮 -->
            <button id="new-character" class="nav-btn" title="新建角色">
                <span class="nav-text">新建</span>
            </button>

            <!-- 保存按钮 -->
            <button id="save-character" class="nav-btn" title="保存角色">
                <span class="nav-text">保存</span>
            </button>

            <button id="show-dice" class="nav-btn" title="显示骰子面板">
                <span class="nav-text" id="show-dice-icon"
                    style="background-image: linear-gradient(0deg, #333333, #333333); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;"><i
                        class="fa-solid fa-dice-d6"></i></span>
            </button>

            <!-- 图鉴按钮 -->
            <button id="show-roster" class="nav-btn" title="显示角色列表">
                <span class="nav-text">图鉴</span>
            </button>

            <!-- 数据管理按钮 (带下拉面板) -->
            <div class="nav-dropdown">
                <button id="show-data" class="nav-btn" title="数据管理">
                    <span class="nav-text">数据</span>
                </button>
            </div>
        </div>
    </div>
    <!-- 骰子面板 -->
    <div id="dice-panel" class="dice-panel">
        <div id="dice-panel-list" class="dice-panel-list active">
            <div class="panel-header">
                <div style="display: flex;max-width: 550px;margin: 0px auto;justify-content: space-around;">
                    <button id="delete-all-dices" class="dice-panel-header-btn">清空</button>
                    <h4 style="margin: 5px auto;">投掷鉴定</h4>
                    <button id="new-dice-preset" class="dice-panel-header-btn">新建</button>
                </div>
            </div>

            <div id="dices-list" class="dices-list active"></div>
        </div>

        <!-- 投掷配置 -->
        <div id="dice-config" class="dice-config">
            <div style="display: flex;justify-content: space-between; width: 100%;">
                <button id="back-to-list" class="toggle-icon"><i class="fa-solid fa-angle-left"></i></button>
                <div style="display: flex;">
                    <button id="show-expression-help" class="toggle-icon">语法指引</button>
                    <button id="save-preset" class="toggle-icon">保存</button>
                </div>
            </div>
            <input type="text" id="preset-name" placeholder="给这个组合起个名字"
                style="margin:0 auto;text-align: center; font-weight: bold; padding: 0 15px;">
            <div class="config-form">
                <div id="expression-help" class="expression-help">支持格式: 2d6, 3d6kh2, 4d6kl3, (1d4+5)等，不支持乘除和中文括号<br>
                    <strong>kh</strong>=保留高值, <strong>kl</strong>=保留低值<br>
                    建议输入顺序：命运骰（2d6）+属性+技能+优势/劣势<br>
                    示例：2d6+4+5-3+(2d6kh1+1)&nbsp;&nbsp;&nbsp;<strong>按[Enter]键投掷</strong>
                </div>
                <div style="display: flex; padding: 10px 0px; margin: 0 10px;">
                    <input type="text" id="dice-expression" class="dice-expression" placeholder="请输入骰子表达式，如：2d6+3">
                    <button id="roll-dice" class="roll-dice">投掷</button>
                </div>
            </div>
        </div>
    </div>
    <!-- 头像上传控件 -->
    <div class="portrait-controls" id="portrait-controls">
        <button class="close-result-modal" id="close-portrait-controls">×</button>
        <label for="upload-portrait" class="btn">上传肖像</label>
        <input type="file" id="upload-portrait" accept="image/*" style="display: none;">
        <button id="remove-portrait" class="btn btn-danger">移除肖像</button>
    </div>
    <!-- 投掷结果显示模态框 -->
    <div id="dice-result-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4>投掷结果</h4>
                <button class="close-result-modal" id="close-result-modal">×</button>
            </div>
            <div class="modal-body">
                <div id="dice-calculation"></div>
                <div id="dice-result" class="result-final"></div>
            </div>
        </div>
    </div>
    <!-- 图鉴面板 -->
    <div id="roster-panel" class="roster-panel">
        <div class="panel-header">
            <div class="roster-tabs">
                <button class="tab-btn active" data-tab="characters">角色</button>
                <button class="tab-btn" data-tab="blessings">赐福</button>
                <button class="tab-btn" data-tab="skills">技能</button>
                <button class="tab-btn" data-tab="equipments">装备</button>
                <button class="tab-btn" data-tab="inventory">背包</button>
                <button class="tab-btn" data-tab="classes">职业</button>
            </div>
        </div>

        <div id="characters-list" class="roster-list tab-content active"></div>

        <div id="blessings-list" class="roster-list tab-content"></div>

        <div id="skills-list" class="roster-list tab-content"></div>

        <div id="equipments-list" class="roster-list tab-content"></div>

        <div id="inventory-list" class="roster-list tab-content"></div>

        <div id="classes-list" class="roster-list tab-content"></div>
    </div>

    <div id="data-panel" class="data-panel">
        <div class="panel-header">
            <h4>数据管理</h4>
        </div>
        <div class="data-button-container">
            <small
                style="color: #666666; font-size: 12px; line-height: 1;">注：</br>
                1、所有角色数据存储在本地浏览器的indexdb中，数据库文件名为GOGCharacterDB</br>
                2、使用无痕模式可能导致indexdb数据丢失</br>
                3、如果QQ上打开导出的WORD中表格显示有问题，请先在office中任意修改再点击保存，或能解决问题</br>
                4、<strong>导出前请务必先保存</strong>
            </small>
            </br>
            </br>
            <label id="import-character" class="data-btn" style="border-radius: 8px 8px 0px 0px;">
                导入角色
                <input type="file" accept=".json" style="display: none;">
            </label>
            <label id="import-full-data" class="data-btn" style="border-radius: 0px;">
                导入图鉴
                <input type="file" accept=".js" style="display: none;">
            </label>
            <button id="export-character" class="data-btn" style="border-radius: 0px;">
                导出当前角色
            </button>
            <button id="export-word" class="data-btn" style="border-radius: 0px;">
                导出当前为Word
            </button>
            <button id="export-all" class="data-btn" style="border-radius: 0px;">
                导出全部角色
            </button>
            <button id="delete-db-btn" class="data-btn-danger" title="此操作将永久删除所有角色以及图鉴数据，不可恢复！"
                style="border-radius: 0px 0px 8px 8px;">
                删除数据库
            </button>
        </div>
    </div>

    <script src="scripts/db.js"></script>
    <script src="scripts/models.js"></script>
    <script src="scripts/import-export.js"></script>
    <script src="scripts/app.js"></script>
    <script src="scripts/data.js"></script>
</body>

</html>